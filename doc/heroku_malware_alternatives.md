# Heroku マルウェアスキャン - 代替案

## 問題

指定したClamAV buildpackがHerokuで利用できない問題が発生しました。

## 推奨される解決策

### オプション1: Heroku環境ではマルウェアスキャンを無効化（推奨）

最も実用的なアプローチは、Heroku環境では`MALWARE_SCAN_ENABLED=false`（または未設定）のままにし、
マルウェアスキャンを無効化することです。

**理由**:
- ClamAVはメモリを大量消費（200-400MB）
- Herokuのコストが増加（Standard-2X以上が必要）
- buildpackのメンテナンスが困難
- ファイルアップロードのパフォーマンスに影響

**実装**:
```bash
# Heroku環境ではMALWARE_SCAN_ENABLEDを設定しない
# （または明示的にfalseに設定）
heroku config:unset MALWARE_SCAN_ENABLED -a your-app-name

# または
heroku config:set MALWARE_SCAN_ENABLED=false -a your-app-name
```

### オプション2: 外部APIサービスを使用

無料のマルウェアスキャンAPIを使用する方法：

#### VirusTotal API（無料枠あり）

- 無料プラン: 4リクエスト/分
- URL: https://www.virustotal.com/gui/home/upload
- API: https://developers.virustotal.com/reference/overview

**実装例**:

```ruby
# app/services/virus_total_scanner.rb
class VirusTotalScanner
  API_KEY = ENV['VIRUSTOTAL_API_KEY']
  API_URL = 'https://www.virustotal.com/api/v3/files'

  def self.scan!(file_path)
    return true unless ENV['MALWARE_SCAN_ENABLED'] == 'true'
    return true unless API_KEY.present?

    # ファイルをVirusTotalにアップロード
    response = HTTP.post(API_URL, 
      headers: { 'x-apikey' => API_KEY },
      form: { file: HTTP::FormData::File.new(file_path) }
    )

    if response.status.success?
      analysis_id = JSON.parse(response.body)['data']['id']
      # 分析結果を取得（ポーリングが必要）
      check_analysis(analysis_id)
    else
      raise "VirusTotal API error: #{response.status}"
    end
  end

  def self.check_analysis(analysis_id)
    # 実装が必要
  end
end
```

**メリット**:
- Heroku環境で追加のリソース不要
- 最新のウイルス定義を使用
- 複数のエンジンでスキャン

**デメリット**:
- API制限がある（無料プランは4リクエスト/分）
- 外部サービス依存
- レスポンス時間が長い

### オプション3: AWS Lambda + ClamAV

より高度な実装として、AWS Lambdaでマルウェアスキャンサービスを構築：

1. AWS Lambda関数でClamAVを実行
2. S3にファイルがアップロードされたらトリガー
3. スキャン結果をWebhookで通知

**参考**:
- https://github.com/upsidetravel/bucket-antivirus-function

### オプション4: 別のClamAV Buildpackを試す

以下のbuildpackを試すことができます（メンテナンス状況は要確認）：

```bash
# 1. 既存のbuildpackを削除
heroku buildpacks:remove https://github.com/scantist-ossops-m2/heroku-buildpack-clamav.git -a your-app-name

# 2. 別のbuildpackを試す
heroku buildpacks:add --index 1 https://github.com/halogenandtoast/heroku-buildpack-clamav -a your-app-name

# または
heroku buildpacks:add --index 1 https://github.com/mzp/heroku-buildpack-clamav -a your-app-name
```

## 推奨される最終的なアプローチ

### フェーズ1: 初期リリース（即座に実装可能）

**Heroku本番環境**: マルウェアスキャンを無効化
```bash
heroku config:set MALWARE_SCAN_ENABLED=false -a production-app
```

**理由**:
- すぐにデプロイ可能
- コスト効率が良い
- パフォーマンスへの影響なし

### フェーズ2: 将来的な実装（リソースがある場合）

以下のいずれかを検討：

1. **AWS S3 + Lambda + ClamAV**
   - ファイルをS3にアップロード
   - Lambda関数でバックグラウンドスキャン
   - 最もスケーラブル

2. **VirusTotal API**
   - 簡単に統合可能
   - 有料プランで制限を緩和

3. **専用のスキャンサーバー**
   - EC2インスタンスでClamAVを実行
   - APIエンドポイントを提供

## セキュリティのベストプラクティス（スキャン無しの場合）

マルウェアスキャンを無効化する場合、以下の対策を実施してください：

1. **ファイルタイプの制限**
   ```ruby
   validates :file, 
     content_type: ['image/png', 'image/jpeg', 'image/gif', 'application/pdf']
   ```

2. **ファイルサイズの制限**
   ```ruby
   validates :file, 
     size: { less_than: 10.megabytes }
   ```

3. **ファイル名のサニタイズ**（既に実装済み - CarrierWave）

4. **アップロード元の制限**
   - 認証済みユーザーのみ許可
   - レート制限を実装

5. **Content Security Policy (CSP)**
   - アップロードされたファイルの実行を防ぐ

6. **定期的な監視**
   - 不審なファイルのパターンを監視
   - アップロード頻度の異常を検知

## 結論

**即座の対応**: Heroku環境でマルウェアスキャンを無効化し、上記のセキュリティ対策を実施。

**将来の実装**: リソースと要件に応じて、AWS Lambda + ClamAVまたはVirusTotal APIを検討。

