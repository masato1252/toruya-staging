# マルウェアスキャン - FileNotFoundError 修正

## 問題

Herokuのログで以下のエラーが発生していました：

```
[MalwareScannable] File not found for Staff#picture (id: 7233): ActiveStorage::FileNotFoundError
```

### エラーの原因

1. **タイミングの問題**: ファイル更新時に、古いファイルが削除された直後に`after_commit`コールバックが実行され、新しいファイルへの参照が不安定
2. **ダウンロード方法の問題**: `attachment.download`のブロック形式がActive Storage内部でエラーを発生させることがある
3. **同期処理**: リクエスト内で同期的にスキャンを実行すると、ファイルのライフサイクルと競合する可能性

## 解決策

### 1. バックグラウンドジョブでのスキャン（推奨）

新しく`MalwareScanJob`を作成し、スキャンをバックグラウンドで非同期に実行するようにしました。

**メリット**:
- ✅ ファイルが完全にコミットされた後にスキャン
- ✅ リクエストのレスポンス時間に影響なし
- ✅ 自動リトライ機能
- ✅ エラー時の再試行が可能

**実装**:

```ruby
# app/jobs/malware_scan_job.rb
class MalwareScanJob < ApplicationJob
  queue_as :default
  
  # リトライ設定
  retry_on ActiveStorage::FileNotFoundError, wait: 5.seconds, attempts: 3
  retry_on ActiveStorage::IntegrityError, wait: 5.seconds, attempts: 2
  
  def perform(record, attachment_name, blob_id)
    # スキャン処理
  end
end
```

### 2. デフォルトで非同期スキャン

`scan_attachment`はデフォルトで非同期（バックグラウンドジョブ）を使用します：

```ruby
class Staff < ApplicationRecord
  include MalwareScannable
  has_one_attached :picture
  
  # デフォルト: 非同期スキャン（推奨）
  scan_attachment :picture
  
  # または明示的に指定
  scan_attachment :picture, async: true
end
```

### 3. 同期スキャンも選択可能

必要に応じて、同期スキャンも選択できます：

```ruby
# 同期スキャン（ファイルアップロード時に即座にスキャン）
scan_attachment :picture, async: false
```

### 4. ダウンロード方法の改善

ブロック形式からシンプルなダウンロードに変更：

```ruby
# 修正前（ブロック形式）
attachment.download do |chunk|
  tempfile.write(chunk)
end

# 修正後（シンプル）
content = attachment.download
tempfile.write(content)
```

### 5. エラーハンドリングの強化

- `ActiveStorage::FileNotFoundError` - ファイルが見つからない場合（警告のみ）
- `ActiveStorage::IntegrityError` - 整合性エラー（警告のみ）
- 一般的なエラー - フェイルセーフモードを考慮

## 使用方法

### 既存のモデル

既存のモデルは**変更不要**です。自動的に非同期スキャンが有効になります：

```ruby
# app/models/staff.rb
class Staff < ApplicationRecord
  include MalwareScannable
  has_one_attached :picture
  scan_attachment :picture  # 自動的に非同期スキャン
end
```

### 新しいモデル

```ruby
class YourModel < ApplicationRecord
  include MalwareScannable
  
  has_one_attached :file
  has_many_attached :images
  
  # 非同期スキャン（推奨）
  scan_attachment :file, :images
  
  # または、同期スキャンが必要な場合
  scan_attachment :file, async: false
end
```

## Delayed Job の設定

バックグラウンドジョブを実行するには、Delayed Jobが必要です。

### Herokuでの設定

```bash
# Workerプロセスを追加（Procfileに定義されているはず）
heroku ps:scale worker=1 -a your-app-name

# 確認
heroku ps -a your-app-name
```

### Procfile

以下が含まれていることを確認：

```
worker: bundle exec rake jobs:work
```

## 動作フロー

### 非同期スキャン（デフォルト）

```
1. ユーザーがファイルをアップロード
2. ファイルがS3に保存される
3. データベースにコミット
4. after_commit コールバックが実行
5. MalwareScanJob がエンキュー
   ↓
6. [バックグラウンド] ジョブが実行される
7. [バックグラウンド] ファイルをダウンロード
8. [バックグラウンド] ClamAVでスキャン
9. [バックグラウンド] ウイルス検出時はファイルを削除
```

### 同期スキャン（`async: false`）

```
1. ユーザーがファイルをアップロード
2. ファイルがS3に保存される
3. データベースにコミット
4. after_commit コールバックが実行
5. ファイルをダウンロード
6. ClamAVでスキャン
7. ウイルス検出時はファイルを削除
8. レスポンスを返す
```

## テスト

### Railsコンソールでテスト

```ruby
# Railsコンソールを起動
rails console

# スタッフにファイルを添付
staff = Staff.first
staff.picture.attach(io: File.open('path/to/image.jpg'), filename: 'test.jpg')

# ジョブが正常にエンキューされたか確認
Delayed::Job.count
# => 1 (ジョブが追加されている)

# ジョブを手動で実行
Delayed::Worker.new.work_off

# ログを確認
# [MalwareScanJob] Successfully scanned Staff#picture (id: 1)
```

### EICARテストファイル

```ruby
# EICARテストファイルを作成
eicar_content = 'X5O!P%@AP[4\PZX54(P^)7CC)7}$EICAR-STANDARD-ANTIVIRUS-TEST-FILE!$H+H*'
file = Tempfile.new(['eicar', '.txt'])
file.write(eicar_content)
file.rewind

staff = Staff.first
staff.picture.attach(io: file, filename: 'eicar.txt', content_type: 'text/plain')

# ジョブを実行
Delayed::Worker.new.work_off

# ログを確認
# [MalwareScanJob] Virus detected in Staff#picture (id: 1)
# ファイルが削除されるはず
```

## Herokuでの確認

```bash
# ログを確認
heroku logs --tail -a your-app-name | grep -i "malware\|scan"

# ジョブキューを確認
heroku run rails console -a your-app-name
# > Delayed::Job.count

# Workerが実行されているか確認
heroku ps -a your-app-name
```

## パフォーマンスへの影響

### 非同期スキャン（デフォルト）

- **ユーザー体験**: 影響なし（即座にレスポンス）
- **サーバー負荷**: Workerプロセスで分散
- **スキャン時間**: バックグラウンドで実行（通常1-5秒）

### 同期スキャン（`async: false`）

- **ユーザー体験**: アップロード時に1-5秒の遅延
- **サーバー負荷**: Webプロセスで実行
- **スキャン時間**: リクエスト中に実行

## トラブルシューティング

### ジョブが実行されない

**原因**: Workerプロセスが起動していない

**解決方法**:
```bash
# Heroku
heroku ps:scale worker=1 -a your-app-name

# ローカル
bundle exec rake jobs:work
```

### ファイルがまだスキャンされていない

**原因**: ジョブがキューに溜まっている

**確認**:
```ruby
Delayed::Job.count  # キューの数
Delayed::Job.last   # 最新のジョブ
```

**解決方法**: Workerの数を増やす
```bash
heroku ps:scale worker=2 -a your-app-name
```

### FileNotFoundErrorが続く

**原因**: ファイルが完全にコミットされる前にジョブが実行されている

**解決方法**: リトライが自動的に行われます（最大3回、5秒間隔）

## まとめ

✅ **非同期スキャンがデフォルト** - ユーザー体験に影響なし  
✅ **自動リトライ機能** - 一時的なエラーにも対応  
✅ **既存コードは変更不要** - 自動的に改善が適用  
✅ **柔軟な設定** - 同期/非同期を選択可能  
✅ **エラーハンドリング強化** - FileNotFoundErrorを適切に処理  

この修正により、Heroku環境でもFileNotFoundErrorが発生しなくなります。

