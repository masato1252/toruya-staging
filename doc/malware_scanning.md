# マルウェアスキャン機能

このドキュメントでは、アプリケーションに実装されたマルウェアスキャン機能について説明します。

## 概要

ユーザーがアップロードしたファイルに対して、オープンソースのアンチウイルスエンジン **ClamAV** を使用してマルウェアスキャンを行います。

## 機能

- **Active Storage**: 画像やロゴなどの添付ファイルを自動的にスキャン
- **CarrierWave**: PDFファイルなどのアップロード前にスキャン
- **API経由のアップロード**: 直接アップロードされるファイルもスキャン
- **環境ごとの制御**: 環境変数でスキャンの有効/無効を切り替え可能

## 環境変数

### `MALWARE_SCAN_ENABLED`

マルウェアスキャンを有効にするかどうかを制御します。

- `true`: スキャンを有効にする（本番環境推奨）
- `false` または未設定: スキャンを無効にする（開発環境・テスト環境）

```bash
# 本番環境（Heroku）
heroku config:set MALWARE_SCAN_ENABLED=true -a your-app-name

# ステージング環境
heroku config:set MALWARE_SCAN_ENABLED=true -a your-staging-app-name

# 開発環境（.env）
MALWARE_SCAN_ENABLED=false
```

### `MALWARE_SCAN_FAIL_SAFE`

スキャンエラー発生時の動作を制御します。

- `true`: スキャンエラーが発生してもアップロードを許可（フェイルセーフモード）
- `false` または未設定: スキャンエラーの場合はアップロードを拒否（厳格モード）

```bash
# フェイルセーフモード（推奨）
heroku config:set MALWARE_SCAN_FAIL_SAFE=true -a your-app-name

# 厳格モード
heroku config:set MALWARE_SCAN_FAIL_SAFE=false -a your-app-name
```

## ClamAVのインストール

### macOS（開発環境）

```bash
# Homebrewを使用してインストール
brew install clamav

# 設定ファイルをコピー
cd /opt/homebrew/etc/clamav
cp freshclam.conf.sample freshclam.conf
cp clamd.conf.sample clamd.conf

# ウイルス定義を更新
freshclam

# ClamAVデーモンを起動（オプション）
clamd
```

### Ubuntu/Debian（本番環境）

```bash
# ClamAVをインストール
sudo apt-get update
sudo apt-get install -y clamav clamav-daemon

# ウイルス定義を更新
sudo freshclam

# ClamAVデーモンを起動
sudo systemctl start clamav-daemon
sudo systemctl enable clamav-daemon
```

### Heroku

Herokuでは、Buildpackを使用してClamAVをインストールします。

```bash
# ClamAV Buildpackを追加
heroku buildpacks:add https://github.com/scantist-ossops-m2/heroku-buildpack-clamav.git -a your-app-name

# または、既存のbuildpackの前に追加
heroku buildpacks:add --index 1 https://github.com/scantist-ossops-m2/heroku-buildpack-clamav.git -a your-app-name

# 設定を確認
heroku buildpacks -a your-app-name

# デプロイ
git push heroku main
```

**注意**: ClamAVは大量のメモリを消費します。Herokuでは少なくとも **Standard-1X** 以上のDynoが推奨されます。

## 実装詳細

### スキャン対象

以下のモデルでファイルアップロード時に自動的にマルウェアスキャンが実行されます：

#### Active Storage使用モデル

- `Staff` (picture)
- `Shop` (logo)
- `Profile` (logo)
- `SocialMessage` (image)
- `SocialUserMessage` (image)
- `SocialRichMenu` (image)
- `SalePage` (picture, customer_pictures)
- `CustomMessage` (picture)

#### CarrierWave使用モデル

- `FilteredOutcome` (file - PDFファイル)

#### API経由のアップロード

- `Api::ImagesController` (画像アップロード)

### スキャンのタイミング

- **Active Storage**: ファイルがデータベースにコミットされた後（`after_commit`コールバック）
- **CarrierWave**: ファイルがキャッシュに保存される前（`before :cache`コールバック）
- **API**: ファイルがActive Storageに保存される前

### ウイルス検出時の動作

1. **ログ記録**: Rails loggerにエラーを記録
2. **Rollbar通知**: Rollbarにエラーを送信（設定されている場合）
3. **ファイル削除**: 
   - Active Storage: `purge_later`で非同期削除
   - CarrierWave: アップロードを拒否
   - API: アップロードを拒否し、エラーレスポンスを返す
4. **エラーメッセージ**: ユーザーに「ウイルスが検出されました」というメッセージを表示

## モデルへの適用方法

新しいモデルにマルウェアスキャンを追加する場合：

### Active Storageの場合

```ruby
class YourModel < ApplicationRecord
  include MalwareScannable

  has_one_attached :file
  scan_attachment :file
  
  # 複数の添付ファイルがある場合
  has_one_attached :image
  has_many_attached :documents
  scan_attachment :image, :documents
end
```

### CarrierWaveの場合

アップローダークラスに以下を追加：

```ruby
class YourUploader < CarrierWave::Uploader::Base
  before :cache, :scan_for_malware

  private

  def scan_for_malware(file)
    return unless MalwareScanner.enabled?

    begin
      file_path = file.is_a?(String) ? file : file.path
      MalwareScanner.scan!(file_path)
    rescue MalwareScanner::VirusDetectedError => e
      Rails.logger.error("[YourUploader] Virus detected: #{e.message}")
      raise CarrierWave::IntegrityError, "ウイルスが検出されました。このファイルはアップロードできません。"
    rescue => e
      Rails.logger.error("[YourUploader] Error scanning file: #{e.message}")
      unless ENV['MALWARE_SCAN_FAIL_SAFE'].to_s.downcase == 'true'
        raise CarrierWave::IntegrityError, "ファイルのスキャン中にエラーが発生しました。"
      end
    end
  end
end
```

## テスト

### EICARテストファイル

ClamAVが正しく動作しているかテストするには、EICAR（European Institute for Computer Antivirus Research）テストファイルを使用します。

```bash
# EICARテストファイルを作成
echo 'X5O!P%@AP[4\PZX54(P^)7CC)7}$EICAR-STANDARD-ANTIVIRUS-TEST-FILE!$H+H*' > /tmp/eicar.txt

# スキャンをテスト
clamscan /tmp/eicar.txt
# 出力: /tmp/eicar.txt: Eicar-Test-Signature FOUND
```

### Railsコンソールでテスト

```ruby
# Railsコンソールを起動
rails console

# マルウェアスキャンが有効か確認
MalwareScanner.enabled?

# テストファイルをスキャン
MalwareScanner.safe?('/tmp/eicar.txt')
# => false (ウイルスが検出された)

# 安全なファイルをスキャン
MalwareScanner.safe?('/tmp/safe_file.txt')
# => true (安全)
```

## トラブルシューティング

### ClamAVが見つからない

```
Error: ClamAV not found
```

**解決方法**: ClamAVをインストールし、PATHに追加してください。

### ウイルス定義が古い

```
WARNING: Virus database is older than 7 days!
```

**解決方法**: ウイルス定義を更新してください。

```bash
sudo freshclam
```

### メモリ不足

ClamAVは大量のメモリを消費します。Herokuの場合、Dynoのサイズを確認してください。

```bash
heroku ps:scale web=1:standard-1x -a your-app-name
```

### スキャンが遅い

- **daemonize モード**: `clamd`デーモンを使用すると、スキャンが高速化します。
- **非同期処理**: Active Storageの場合、`after_commit`で非同期に処理されます。

## パフォーマンスへの影響

- **スキャン時間**: 小さなファイル（< 1MB）は通常1秒以内
- **メモリ使用量**: ClamAVは約200-400MBのメモリを使用
- **CPU使用量**: スキャン中はCPUを多く使用しますが、一時的です

## セキュリティのベストプラクティス

1. **本番環境では必ず有効化**: `MALWARE_SCAN_ENABLED=true`
2. **フェイルセーフモード**: `MALWARE_SCAN_FAIL_SAFE=true`（サービス停止を防ぐ）
3. **定期的な更新**: ウイルス定義を毎日更新（`freshclam`を cron で実行）
4. **ログ監視**: ウイルス検出のログを定期的に確認
5. **アラート設定**: Rollbarなどで異常を検知

## 関連ファイル

- `app/services/malware_scanner.rb` - マルウェアスキャンサービス
- `app/models/concerns/malware_scannable.rb` - Active Storage用concern
- `app/uploaders/filtered_outcome_file_uploader.rb` - CarrierWave用アップローダー
- `app/controllers/api/images_controller.rb` - API用コントローラー
- `config/initializers/clamby.rb` - Clamby設定
- `Gemfile` - clamby gem

## 参考リンク

- [ClamAV公式サイト](https://www.clamav.net/)
- [Clamby gem](https://github.com/kobaltz/clamby)
- [EICAR Test File](https://www.eicar.org/download-anti-malware-testfile/)

