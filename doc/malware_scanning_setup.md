# マルウェアスキャン機能 - セットアップガイド

このガイドでは、マルウェアスキャン機能を有効にするための手順を説明します。

## クイックスタート

### 1. Gemのインストール

```bash
bundle install
```

### 2. ClamAVのインストール

#### 開発環境（macOS）

```bash
brew install clamav
cd /opt/homebrew/etc/clamav
cp freshclam.conf.sample freshclam.conf
cp clamd.conf.sample clamd.conf
freshclam
```

#### 本番環境（Heroku）

```bash
# ClamAV Buildpackを追加
heroku buildpacks:add --index 1 https://github.com/scantist-ossops-m2/heroku-buildpack-clamav.git -a your-app-name

# デプロイ
git push heroku main
```

### 3. 環境変数の設定

#### ローカル環境（.env）

```bash
# 開発環境ではスキャンを無効化（オプション）
MALWARE_SCAN_ENABLED=false
```

#### Heroku（本番環境）

```bash
# マルウェアスキャンを有効化
heroku config:set MALWARE_SCAN_ENABLED=true -a your-app-name

# フェイルセーフモードを有効化（推奨）
heroku config:set MALWARE_SCAN_FAIL_SAFE=true -a your-app-name
```

### 4. 動作確認

```bash
# Railsコンソールで確認
rails console

# スキャンが有効か確認
MalwareScanner.enabled?
# => true（本番環境）or false（開発環境）

# ClamAVが利用可能か確認
MalwareScanner.scan!('/tmp/test.txt')
# エラーが出なければOK
```

## 環境別の推奨設定

| 環境 | MALWARE_SCAN_ENABLED | MALWARE_SCAN_FAIL_SAFE | 理由 |
|------|---------------------|------------------------|------|
| 開発環境 | `false` | - | ClamAVのインストールが不要 |
| ステージング | `true` | `true` | 本番相当のテスト、エラー時も停止しない |
| 本番環境 | `true` | `true` | セキュリティ確保、サービス停止を防ぐ |

## Herokuへのデプロイ手順

### ステップ1: Buildpackの追加

```bash
# 現在のbuildpackを確認
heroku buildpacks -a your-app-name

# ClamAV Buildpackを先頭に追加
heroku buildpacks:add --index 1 https://github.com/scantist-ossops-m2/heroku-buildpack-clamav.git -a your-app-name

# 確認
heroku buildpacks -a your-app-name
# 出力例:
# 1. https://github.com/scantist-ossops-m2/heroku-buildpack-clamav.git
# 2. heroku/ruby
```

### ステップ2: 環境変数の設定

```bash
# 本番環境
heroku config:set MALWARE_SCAN_ENABLED=true -a your-production-app
heroku config:set MALWARE_SCAN_FAIL_SAFE=true -a your-production-app

# ステージング環境
heroku config:set MALWARE_SCAN_ENABLED=true -a your-staging-app
heroku config:set MALWARE_SCAN_FAIL_SAFE=true -a your-staging-app
```

### ステップ3: Dynoサイズの確認

ClamAVは200-400MBのメモリを使用するため、Standard-1X以上が推奨されます。

```bash
# 現在のDynoサイズを確認
heroku ps -a your-app-name

# 必要に応じてアップグレード
heroku ps:scale web=1:standard-1x -a your-app-name
```

### ステップ4: デプロイ

```bash
# mainブランチをHerokuにプッシュ
git push heroku main

# または、特定のブランチから
git push heroku your-branch:main

# ログを確認
heroku logs --tail -a your-app-name
```

### ステップ5: 動作確認

```bash
# Railsコンソールを起動
heroku run rails console -a your-app-name

# スキャンが有効か確認
MalwareScanner.enabled?
# => true

# ClamAVが利用可能か確認（Railsコンソール内で実行）
require 'clamby'
Clamby.safe?
# => true
```

## トラブルシューティング

### ❌ ClamAVが見つからない

**症状**: `ClamAV not found` エラー

**解決方法**:
1. Buildpackが正しく追加されているか確認
2. デプロイ後、Dynoを再起動
   ```bash
   heroku restart -a your-app-name
   ```

### ❌ メモリ不足エラー

**症状**: `R14 - Memory quota exceeded`

**解決方法**:
1. Dynoサイズをアップグレード
   ```bash
   heroku ps:scale web=1:standard-2x -a your-app-name
   ```

### ❌ スキャンがタイムアウト

**症状**: ファイルアップロードが遅い

**解決方法**:
1. `MALWARE_SCAN_FAIL_SAFE=true` に設定
2. 大きなファイルは非同期処理を検討

### ⚠️ ウイルス定義が古い警告

**症状**: `WARNING: Virus database is older than 7 days!`

**対応**:
- Herokuでは、Dyno再起動時に自動更新されます
- 定期的にDynoを再起動することを推奨

## 動作テスト

### EICARテストファイル

```bash
# Railsコンソールでテスト
rails console

# EICARテストファイルを作成
File.write('/tmp/eicar.txt', 'X5O!P%@AP[4\PZX54(P^)7CC)7}$EICAR-STANDARD-ANTIVIRUS-TEST-FILE!$H+H*')

# スキャンをテスト（ウイルスが検出されるはず）
MalwareScanner.safe?('/tmp/eicar.txt')
# => false

# 例外が発生するかテスト
MalwareScanner.scan!('/tmp/eicar.txt')
# => MalwareScanner::VirusDetectedError が発生
```

### 実際のファイルアップロードテスト

1. アプリケーションにログイン
2. ファイルアップロード機能にアクセス
3. EICARテストファイルをアップロード
4. 「ウイルスが検出されました」というエラーメッセージが表示されることを確認

## 監視とログ

### ログの確認

```bash
# Herokuのログをリアルタイムで確認
heroku logs --tail -a your-app-name | grep MalwareScanner

# 特定の期間のログを確認
heroku logs --since="1 hour ago" -a your-app-name | grep -i virus
```

### 監視すべき項目

- ✅ `[MalwareScanner] Malware scanning is enabled`
- ✅ `[Clamby] ClamAV is available and working`
- ⚠️ `[MalwareScanner] Virus detected` - ウイルス検出（要注意）
- ⚠️ `[MalwareScanner] Error scanning file` - スキャンエラー
- ⚠️ `[Clamby] ClamAV is not available` - ClamAV利用不可

## よくある質問

### Q: 開発環境でClamAVをインストールしたくない

A: `.env` ファイルで `MALWARE_SCAN_ENABLED=false` に設定すれば、スキャンは実行されません。

### Q: スキャンに失敗した場合、アップロードはどうなる？

A: 
- `MALWARE_SCAN_FAIL_SAFE=true`: アップロードを許可（推奨）
- `MALWARE_SCAN_FAIL_SAFE=false`: アップロードを拒否

### Q: すでにアップロードされているファイルをスキャンできる？

A: 以下のRakeタスクを作成して実行できます：

```ruby
# lib/tasks/malware_scan.rake
namespace :malware do
  desc "Scan all uploaded files"
  task scan_all: :environment do
    # 実装例
  end
end
```

### Q: パフォーマンスへの影響は？

A: 
- 小さなファイル（< 1MB）: 1秒以内
- 大きなファイル（> 10MB）: 数秒
- Active Storageは非同期処理のため、ユーザー体験への影響は最小限

## サポート

詳細なドキュメントは `doc/malware_scanning.md` を参照してください。

## チェックリスト

デプロイ前に以下を確認：

- [ ] `bundle install` を実行
- [ ] Buildpackを追加（Heroku）
- [ ] `MALWARE_SCAN_ENABLED=true` を設定
- [ ] `MALWARE_SCAN_FAIL_SAFE=true` を設定
- [ ] Dynoサイズを確認（Standard-1X以上）
- [ ] デプロイ後、ログを確認
- [ ] EICARファイルでテスト
- [ ] 実際のファイルアップロードをテスト

