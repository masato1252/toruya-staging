# frozen_string_literal: true

class MalwareScanner
  class VirusDetectedError < StandardError; end

  # マルウェアスキャンが有効かどうかを確認
  def self.enabled?
    ENV['MALWARE_SCAN_ENABLED'].to_s.downcase == 'true'
  end

  # ファイルをスキャンして、ウイルスが検出された場合は例外を発生させる
  # @param file_path [String] スキャンするファイルのパス
  # @raise [VirusDetectedError] ウイルスが検出された場合
  # @return [Boolean] スキャンが成功した場合はtrue
  def self.scan!(file_path)
    return true unless enabled?

    unless File.exist?(file_path)
      Rails.logger.error("[MalwareScanner] File not found: #{file_path}")
      raise ArgumentError, "File not found: #{file_path}"
    end

    Rails.logger.info("[MalwareScanner] Scanning file: #{file_path}")
    
    begin
      require 'clamby'
      
      # ClamAVがインストールされているか確認
      unless Clamby.safe?
        Rails.logger.warn("[MalwareScanner] ClamAV is not available, skipping scan")
        return true
      end

      # ファイルをスキャン
      if Clamby.virus?(file_path)
        virus_info = Clamby.virus_info(file_path)
        error_message = "Virus detected in file: #{virus_info}"
        Rails.logger.error("[MalwareScanner] #{error_message}")
        
        # Rollbarなどのエラートラッキングに通知
        Rollbar.error(error_message, file_path: file_path, virus_info: virus_info) if defined?(Rollbar)
        
        raise VirusDetectedError, error_message
      end

      Rails.logger.info("[MalwareScanner] File is clean: #{file_path}")
      true
    rescue => e
      if e.is_a?(VirusDetectedError)
        raise e
      else
        Rails.logger.error("[MalwareScanner] Error scanning file: #{e.message}")
        Rails.logger.error(e.backtrace.join("\n"))
        
        # スキャンエラーの場合、設定に応じて処理を変える
        if ENV['MALWARE_SCAN_FAIL_SAFE'].to_s.downcase == 'true'
          # フェイルセーフモード: スキャンエラーの場合はスキャンをスキップ
          Rails.logger.warn("[MalwareScanner] Scan failed but continuing (fail-safe mode)")
          return true
        else
          # 厳格モード: スキャンエラーの場合は例外を発生
          raise
        end
      end
    end
  end

  # ファイルをスキャンして、結果をブール値で返す
  # @param file_path [String] スキャンするファイルのパス
  # @return [Boolean] ウイルスが検出されなかった場合はtrue
  def self.safe?(file_path)
    scan!(file_path)
    true
  rescue VirusDetectedError
    false
  end
end

