# frozen_string_literal: true

# Active Storageの添付ファイルに対してマルウェアスキャンを行うためのConcern
#
# 使用方法:
#   class YourModel < ApplicationRecord
#     include MalwareScannable
#     has_one_attached :file
#     scan_attachment :file
#   end
#
# 複数の添付ファイルがある場合:
#   scan_attachment :file, :image, :document
#
module MalwareScannable
  extend ActiveSupport::Concern

  class_methods do
    # 指定された添付ファイルに対してマルウェアスキャンを設定
    # @param attachment_names [Symbol] 添付ファイルの名前（複数指定可）
    def scan_attachment(*attachment_names)
      attachment_names.each do |attachment_name|
        # 添付ファイルがコミットされた後にスキャンを実行
        after_commit -> { scan_attachment_after_commit(attachment_name) }, on: [:create, :update]
      end
    end
  end

  private

  # 添付ファイルをスキャン
  def scan_attachment_after_commit(attachment_name)
    return unless MalwareScanner.enabled?
    
    attachment = send(attachment_name)
    return unless attachment.attached?

    # 添付ファイルをダウンロードしてスキャン
    attachment.open do |file|
      begin
        MalwareScanner.scan!(file.path)
      rescue MalwareScanner::VirusDetectedError => e
        # ウイルスが検出された場合、添付ファイルを削除
        Rails.logger.error("[MalwareScannable] Virus detected in #{self.class.name}##{attachment_name} (id: #{id})")
        attachment.purge_later
        
        # エラーを記録（必要に応じて管理者に通知）
        notify_virus_detection(attachment_name, e)
        
        # 例外を再度発生させる（必要に応じて）
        # raise e
      rescue => e
        Rails.logger.error("[MalwareScannable] Error scanning #{self.class.name}##{attachment_name} (id: #{id}): #{e.message}")
        # スキャンエラーの場合、フェイルセーフモードでなければ添付ファイルを削除
        unless ENV['MALWARE_SCAN_FAIL_SAFE'].to_s.downcase == 'true'
          attachment.purge_later
        end
      end
    end
  rescue => e
    Rails.logger.error("[MalwareScannable] Failed to scan attachment #{attachment_name}: #{e.message}")
  end

  # ウイルス検出を通知（必要に応じてカスタマイズ）
  def notify_virus_detection(attachment_name, error)
    # 管理者への通知、メール送信、Slackへの通知など
    # 例: AdminMailer.virus_detected(self, attachment_name, error).deliver_later
  end
end

