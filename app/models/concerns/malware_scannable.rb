# frozen_string_literal: true

# Active Storageの添付ファイルに対してマルウェアスキャンを行うためのConcern
#
# 使用方法:
#   class YourModel < ApplicationRecord
#     include MalwareScannable
#     has_one_attached :file
#     scan_attachment :file
#   end
#
# 複数の添付ファイルがある場合:
#   scan_attachment :file, :image, :document
#
# オプション:
#   scan_attachment :file, async: false  # 同期的にスキャン（デフォルトは非同期）
#
module MalwareScannable
  extend ActiveSupport::Concern

  class_methods do
    # 指定された添付ファイルに対してマルウェアスキャンを設定
    # @param attachment_names [Symbol] 添付ファイルの名前（複数指定可）
    # @param options [Hash] オプション
    #   - async: true（デフォルト） - バックグラウンドジョブで非同期にスキャン
    #   - async: false - 同期的にスキャン
    def scan_attachment(*attachment_names, **options)
      async = options.fetch(:async, true)
      
      attachment_names.each do |attachment_name|
        if async
          # 非同期スキャン（推奨）
          after_commit -> { enqueue_scan_attachment(attachment_name) }, on: [:create, :update]
        else
          # 同期スキャン
          after_commit -> { scan_attachment_after_commit(attachment_name) }, on: [:create, :update]
        end
      end
    end
    
    # 複数添付ファイル（has_many_attached）の場合も同じメソッドを使用可能
    # scan_attachment は単一・複数両方に対応しています
  end

  private

  # バックグラウンドジョブでスキャンをエンキュー
  def enqueue_scan_attachment(attachment_name)
    return unless MalwareScanner.enabled?
    
    attachment = send(attachment_name)
    return unless attachment.attached?

    # has_many_attachedの場合は各ファイルをスキャン
    if attachment.is_a?(ActiveStorage::Attached::Many)
      attachment.each do |single_attachment|
        next unless single_attachment.blob.present?
        MalwareScanJob.perform_later(self, attachment_name.to_s, single_attachment.blob.id)
      end
    else
      # has_one_attachedの場合
      return unless attachment.blob.present?
      MalwareScanJob.perform_later(self, attachment_name.to_s, attachment.blob.id)
    end
  rescue => e
    Rails.logger.error("[MalwareScannable] Failed to enqueue scan for #{attachment_name}: #{e.message}")
  end

  # 添付ファイルをスキャン（has_one_attached と has_many_attached の両方に対応）
  def scan_attachment_after_commit(attachment_name)
    return unless MalwareScanner.enabled?
    
    attachment = send(attachment_name)
    return unless attachment.attached?

    # has_many_attachedの場合は各ファイルをスキャン
    if attachment.is_a?(ActiveStorage::Attached::Many)
      attachment.each_with_index do |single_attachment, index|
        scan_single_attachment(attachment_name, single_attachment, index + 1)
      end
    else
      # has_one_attachedの場合
      scan_single_attachment(attachment_name, attachment)
    end
  rescue => e
    Rails.logger.error("[MalwareScannable] Failed to scan attachment #{attachment_name}: #{e.message}")
  end

  # 単一のファイルをスキャン
  def scan_single_attachment(attachment_name, attachment, index = nil)
    # ファイルが実際に存在するか確認
    return unless attachment.blob.present?

    identifier = index ? "#{attachment_name}[#{index}]" : attachment_name

    # 添付ファイルをダウンロードしてスキャン
    tempfile = nil
    
    begin
      # 一時ファイルにダウンロード
      tempfile = Tempfile.new(['malware_scan', File.extname(attachment.filename.to_s)])
      tempfile.binmode
      
      # Active Storageからファイルをダウンロード（ブロックなしバージョン）
      content = attachment.download
      tempfile.write(content)
      tempfile.rewind
      
      # スキャンを実行
      MalwareScanner.scan!(tempfile.path)
      
      Rails.logger.info("[MalwareScannable] Successfully scanned #{self.class.name}##{identifier} (id: #{id})")
      
    rescue MalwareScanner::VirusDetectedError => e
      # ウイルスが検出された場合、添付ファイルを削除
      Rails.logger.error("[MalwareScannable] Virus detected in #{self.class.name}##{identifier} (id: #{id})")
      attachment.purge_later
      
      # エラーを記録（必要に応じて管理者に通知）
      notify_virus_detection(identifier, e)
      
      # 例外を再度発生させる（必要に応じて）
      # raise e
    rescue ActiveStorage::FileNotFoundError => e
      Rails.logger.warn("[MalwareScannable] File not found for #{self.class.name}##{identifier} (id: #{id}): #{e.message}")
      # ファイルが見つからない場合はスキップ（既に削除されている可能性）
    rescue ActiveStorage::IntegrityError => e
      Rails.logger.warn("[MalwareScannable] Integrity error for #{self.class.name}##{identifier} (id: #{id}): #{e.message}")
      # 整合性エラーの場合もスキップ
    rescue => e
      Rails.logger.error("[MalwareScannable] Error scanning #{self.class.name}##{identifier} (id: #{id}): #{e.message}")
      Rails.logger.error(e.backtrace.first(5).join("\n"))
      
      # スキャンエラーの場合、フェイルセーフモードでなければ添付ファイルを削除
      unless ENV['MALWARE_SCAN_FAIL_SAFE'].to_s.downcase == 'true'
        attachment.purge_later
      end
    ensure
      # 一時ファイルをクリーンアップ
      if tempfile
        tempfile.close
        tempfile.unlink rescue nil
      end
    end
  end

  # ウイルス検出を通知（必要に応じてカスタマイズ）
  def notify_virus_detection(attachment_name, error)
    # 管理者への通知、メール送信、Slackへの通知など
    # 例: AdminMailer.virus_detected(self, attachment_name, error).deliver_later
  end
end

