# frozen_string_literal: true

# Active Storageの添付ファイルをバックグラウンドでスキャンするジョブ
class MalwareScanJob < ApplicationJob
  queue_as :default
  
  # リトライ設定
  retry_on ActiveStorage::FileNotFoundError, wait: 5.seconds, attempts: 3
  retry_on ActiveStorage::IntegrityError, wait: 5.seconds, attempts: 2
  
  # スキャンを実行
  # @param record [ApplicationRecord] スキャン対象のレコード
  # @param attachment_name [String] 添付ファイルの名前
  # @param blob_id [Integer] Active Storage Blobのid
  def perform(record, attachment_name, blob_id)
    return unless MalwareScanner.enabled?
    
    # Blobを取得
    blob = ActiveStorage::Blob.find_by(id: blob_id)
    return unless blob
    
    Rails.logger.info("[MalwareScanJob] Scanning #{record.class.name}##{attachment_name} (id: #{record.id}, blob: #{blob_id})")
    
    # 一時ファイルにダウンロード
    tempfile = nil
    
    begin
      tempfile = Tempfile.new(['malware_scan', File.extname(blob.filename.to_s)])
      tempfile.binmode
      
      # Blobから直接ダウンロード
      blob.download do |chunk|
        tempfile.write(chunk)
      end
      tempfile.rewind
      
      # スキャンを実行
      MalwareScanner.scan!(tempfile.path)
      
      Rails.logger.info("[MalwareScanJob] Successfully scanned #{record.class.name}##{attachment_name} (id: #{record.id})")
      
    rescue MalwareScanner::VirusDetectedError => e
      # ウイルスが検出された場合
      Rails.logger.error("[MalwareScanJob] Virus detected in #{record.class.name}##{attachment_name} (id: #{record.id})")
      
      # Blobを削除
      blob.purge_later
      
      # Rollbarに通知
      Rollbar.error(e, 
        record_class: record.class.name,
        record_id: record.id,
        attachment_name: attachment_name,
        blob_id: blob_id,
        filename: blob.filename.to_s
      ) if defined?(Rollbar)
      
    rescue => e
      Rails.logger.error("[MalwareScanJob] Error scanning #{record.class.name}##{attachment_name} (id: #{record.id}): #{e.message}")
      
      # フェイルセーフモードでなければBlobを削除
      unless ENV['MALWARE_SCAN_FAIL_SAFE'].to_s.downcase == 'true'
        blob.purge_later
      end
      
      # 例外を再度発生させて、リトライさせる
      raise
      
    ensure
      # 一時ファイルをクリーンアップ
      if tempfile
        tempfile.close
        tempfile.unlink rescue nil
      end
    end
  end
end

