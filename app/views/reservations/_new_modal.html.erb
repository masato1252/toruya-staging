<%
  manage_self_shop_reservations_no_permission = false
  manage_boss_shop_reservations_no_permission = false
  create_reservation_with_settings_no_permission = false
  create_reservations_with_menu_no_permission = false
%>
<div class="modal fade" id="new-reservations-modal" tabindex="-1" role="dialog">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">×</span></button>
        <h4 class="modal-title">
          予約を追加
        </h4>
      </div>
      <div class="modal-body">
        <div class="shops-list centerize">
          <% working_shop_options(include_user_own: true).each do |option| %>
            <% user_ability = ability(option.owner, option.shop) %>
            <div class="shop-cell">
              <% if user_ability.can?(:create_reservation, option.shop) %>
                <%= link_to_new_reservation(
                  SiteRouting.new(self).reservation_form_path(option.shop.reservations.new, start_time_date_part: @date),
                  option.shop.display_name,
                  class: from_line_bot ? "btn btn-tweak btn-tarco btn-big btn-extend" : "BTNtarco"
                )%>
              <% else %>
                <%
                  create_reservation_with_settings_no_permission = true if user_ability.cannot?(:create, :reservation_with_settings)
                  create_reservations_with_menu_no_permission = true if user_ability.cannot?(:create_shop_reservations_with_menu, option.shop)

                  if user_ability.cannot?(:manage_shop_reservations, option.shop)
                    if option.owner == current_user
                      manage_self_shop_reservations_no_permission = true
                    else
                      manage_boss_shop_reservations_no_permission = true
                    end
                  end
                %>

              <% if option.owner == current_user && user_ability.can?(:manage_shop_reservations, option.shop) &&
                  (
                    user_ability.cannot?(:create, :daily_reservations) ||
                    user_ability.cannot?(:create, :total_reservations) ||
                    user_ability.cannot?(:create, :reservation_with_settings) ||
                    user_ability.cannot?(:create_shop_reservations_with_menu, option.shop)
              ) %>

                <%= modal_link_to(site_routing_helper.create_reservation_warnings_path(owner_id: option.owner.id, shop_id: option.shop.id), class: from_line_bot ? "btn btn-tweak btn-tarco btn-big btn-extend" : "BTNtarco") do %>
                  <i class="fa fa-calendar-plus fa-2x"></i>
                  <span class="new-shop-reservation"><%= option.shop.display_name %></span>
                <% end %>
              <% else %>
                <%= link_to_new_reservation("#", option.shop.display_name, class: "#{from_line_bot ? "btn btn-tweak btn-tarco btn-big btn-extend" : "BTNtarco"} disabled") %>
              <% end %>
            <% end %>
            </div>
          <% end %>
        </div>
        <%=
          if manage_self_shop_reservations_no_permission && manage_boss_shop_reservations_no_permission
            content_tag(:div, t("reservation.modal.invalid_shops_exist_message.manage_shop_reservations_no_permission"))
          elsif manage_self_shop_reservations_no_permission
            content_tag(:div, t("reservation.modal.invalid_shops_exist_message.manage_self_shop_reservations_no_permission"))
          elsif manage_boss_shop_reservations_no_permission
            content_tag(:div, t("reservation.modal.invalid_shops_exist_message.manage_boss_shop_reservations_no_permission"))
          end
        %>
      <%= content_tag(:div, t("reservation.modal.invalid_shops_exist_message.create_reservation_with_settings_no_permission")) if create_reservation_with_settings_no_permission %>
      <%= content_tag(:div, t("reservation.modal.invalid_shops_exist_message.create_reservations_with_menu_no_permission")) if create_reservations_with_menu_no_permission %>
      </div>
    </div>
  </div>
</div>
